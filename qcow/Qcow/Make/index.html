<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"><head><title>Make (qcow.Qcow.Make)</title><link rel="stylesheet" href="../../../odoc.css"/><meta charset="utf-8"/><meta name="generator" content="odoc 1.5.0"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/><script src="../../../highlight.pack.js"></script><script>hljs.initHighlightingOnLoad();</script></head><body><div class="content"><header><nav><a href="../index.html">Up</a> – <a href="../../index.html">qcow</a> &#x00BB; <a href="../index.html">Qcow</a> &#x00BB; Make</nav><h1>Module <code>Qcow.Make</code></h1></header><h3 class="heading">Parameters</h3><ul><li><code><a href="argument-1-B/index.html">B</a> : <a href="../../Qcow_s/index.html#module-type-RESIZABLE_BLOCK">Qcow_s.RESIZABLE_BLOCK</a></code></li><li><code>Time : Mirage_time.S</code></li></ul><h3 class="heading">Signature</h3><div><div class="spec include"><div class="doc"><details open="open"><summary><span class="def"><code><span class="keyword">include</span> Mirage_block.S</code></span></summary><dl><dt class="spec type" id="type-error"><a href="#type-error" class="anchor"></a><code><span class="keyword">type</span> error</code> = <span class="keyword">private</span> <code>[&gt; </code><table class="variant"><tr id="type-error.Mirage_device.error" class="anchored"><td class="def type"><a href="#type-error.Mirage_device.error" class="anchor"></a><code>| </code><code>Mirage_device.error</code></td></tr></table><code> ]</code></dt></dl><dl><dt class="spec value" id="val-pp_error"><a href="#val-pp_error" class="anchor"></a><code><span class="keyword">val</span> pp_error : <span><a href="index.html#type-error">error</a> Fmt.t</span></code></dt></dl><dl><dt class="spec type" id="type-write_error"><a href="#type-write_error" class="anchor"></a><code><span class="keyword">type</span> write_error</code> = <span class="keyword">private</span> <code>[&gt; </code><table class="variant"><tr id="type-write_error.Disconnected" class="anchored"><td class="def constructor"><a href="#type-write_error.Disconnected" class="anchor"></a><code>| </code><code>`Disconnected</code></td></tr><tr id="type-write_error.Is_read_only" class="anchored"><td class="def constructor"><a href="#type-write_error.Is_read_only" class="anchor"></a><code>| </code><code>`Is_read_only</code></td></tr><tr id="type-write_error.Unimplemented" class="anchored"><td class="def constructor"><a href="#type-write_error.Unimplemented" class="anchor"></a><code>| </code><code>`Unimplemented</code></td></tr></table><code> ]</code></dt></dl><dl><dt class="spec value" id="val-pp_write_error"><a href="#val-pp_write_error" class="anchor"></a><code><span class="keyword">val</span> pp_write_error : <span><a href="index.html#type-write_error">write_error</a> Fmt.t</span></code></dt></dl><dl><dt class="spec type" id="type-t"><a href="#type-t" class="anchor"></a><code><span class="keyword">type</span> t</code></dt></dl><dl><dt class="spec value" id="val-disconnect"><a href="#val-disconnect" class="anchor"></a><code><span class="keyword">val</span> disconnect : <a href="index.html#type-t">t</a> <span>&#45;&gt;</span> <span>unit Lwt.t</span></code></dt><dt class="spec value" id="val-get_info"><a href="#val-get_info" class="anchor"></a><code><span class="keyword">val</span> get_info : <a href="index.html#type-t">t</a> <span>&#45;&gt;</span> <span>Mirage_block.info Lwt.t</span></code></dt><dt class="spec value" id="val-read"><a href="#val-read" class="anchor"></a><code><span class="keyword">val</span> read : <a href="index.html#type-t">t</a> <span>&#45;&gt;</span> int64 <span>&#45;&gt;</span> <span>Cstruct.t list</span> <span>&#45;&gt;</span> <span><span><span>(unit, <a href="index.html#type-error">error</a>)</span> Stdlib.result</span> Lwt.t</span></code></dt><dt class="spec value" id="val-write"><a href="#val-write" class="anchor"></a><code><span class="keyword">val</span> write : <a href="index.html#type-t">t</a> <span>&#45;&gt;</span> int64 <span>&#45;&gt;</span> <span>Cstruct.t list</span> <span>&#45;&gt;</span> <span><span><span>(unit, <a href="index.html#type-write_error">write_error</a>)</span> Stdlib.result</span> Lwt.t</span></code></dt></dl></details></div></div></div><div class="spec module" id="module-Config"><a href="#module-Config" class="anchor"></a><code><span class="keyword">module</span> <a href="Config/index.html">Config</a> : <span class="keyword">sig</span> ... <span class="keyword">end</span></code></div><div class="spec module" id="module-Stats"><a href="#module-Stats" class="anchor"></a><code><span class="keyword">module</span> <a href="Stats/index.html">Stats</a> : <span class="keyword">sig</span> ... <span class="keyword">end</span></code></div><dl><dt class="spec value" id="val-create"><a href="#val-create" class="anchor"></a><code><span class="keyword">val</span> create : <a href="index.html#argument-1-B">B</a>.t <span>&#45;&gt;</span> <span>size:int64</span> <span>&#45;&gt;</span> <span>?&#8288;lazy_refcounts:bool</span> <span>&#45;&gt;</span> <span>?&#8288;cluster_bits:int</span> <span>&#45;&gt;</span> <span>?&#8288;config:<a href="Config/index.html#type-t">Config.t</a></span> <span>&#45;&gt;</span> unit <span>&#45;&gt;</span> <span><span><span>(<a href="index.html#type-t">t</a>, <a href="index.html#type-write_error">write_error</a>)</span> Stdlib.result</span> Lwt.t</span></code></dt><dd><p><code>create block ~size ?lazy_refcounts ?cluster_bits ?config ()</code> initialises a qcow-formatted image on <code>block</code> with virtual size <code>size</code> in bytes.</p><p>By default the file will use lazy refcounts, but this can be overriden by supplying <code>~lazy_refcounts:false</code>. By default the file will use 64KiB clusters (= 16 bits) but this can be overridden by supplying <code>?cluster_bits</code>. Note the cluster size must be greater than the sector size on the underlying block device.</p><p>The <code>?config</code> argument does not affect the on-disk format but rather the behaviour as seen from this client.</p></dd></dl><dl><dt class="spec value" id="val-connect"><a href="#val-connect" class="anchor"></a><code><span class="keyword">val</span> connect : <span>?&#8288;config:<a href="Config/index.html#type-t">Config.t</a></span> <span>&#45;&gt;</span> <a href="index.html#argument-1-B">B</a>.t <span>&#45;&gt;</span> <span><a href="index.html#type-t">t</a> Lwt.t</span></code></dt><dd><p><code>connect ?config block</code> connects to an existing qcow-formatted image on <code>block</code>.</p></dd></dl><dl><dt class="spec value" id="val-resize"><a href="#val-resize" class="anchor"></a><code><span class="keyword">val</span> resize : <a href="index.html#type-t">t</a> <span>&#45;&gt;</span> <span>new_size:int64</span> <span>&#45;&gt;</span> <span>?&#8288;ignore_data_loss:bool</span> <span>&#45;&gt;</span> unit <span>&#45;&gt;</span> <span><span><span>(unit, <a href="index.html#type-write_error">write_error</a>)</span> Stdlib.result</span> Lwt.t</span></code></dt><dd><p><code>resize block new_size_bytes ?ignore_data_loss</code> changes the size of the qcow-formatted image to <code>new_size_bytes</code>, rounded up to the next allocation unit. This function will fail with an error if the new size would be smaller than the old size as this would cause data loss, unless the argument <code>?ignore_data_loss</code> is set to true.</p></dd></dl><dl><dt class="spec type" id="type-compact_result"><a href="#type-compact_result" class="anchor"></a><code><span class="keyword">type</span> compact_result</code><code> = </code><code>{</code><table class="record"><tr id="type-compact_result.copied" class="anchored"><td class="def field"><a href="#type-compact_result.copied" class="anchor"></a><code>copied : int64;</code></td><td class="doc"><p>number of sectors copied</p></td></tr><tr id="type-compact_result.refs_updated" class="anchored"><td class="def field"><a href="#type-compact_result.refs_updated" class="anchor"></a><code>refs_updated : int64;</code></td><td class="doc"><p>number of cluster references updated</p></td></tr><tr id="type-compact_result.old_size" class="anchored"><td class="def field"><a href="#type-compact_result.old_size" class="anchor"></a><code>old_size : int64;</code></td><td class="doc"><p>previous size in sectors</p></td></tr><tr id="type-compact_result.new_size" class="anchored"><td class="def field"><a href="#type-compact_result.new_size" class="anchor"></a><code>new_size : int64;</code></td><td class="doc"><p>new size in sectors</p></td></tr></table><code>}</code></dt><dd><p>Summary of the compaction run</p></dd></dl><dl><dt class="spec value" id="val-compact"><a href="#val-compact" class="anchor"></a><code><span class="keyword">val</span> compact : <a href="index.html#type-t">t</a> <span>&#45;&gt;</span> <span>?&#8288;progress_cb:<span>(<span>percent:int</span> <span>&#45;&gt;</span> unit)</span></span> <span>&#45;&gt;</span> unit <span>&#45;&gt;</span> <span><span><span>(<a href="index.html#type-compact_result">compact_result</a>, <a href="index.html#type-write_error">write_error</a>)</span> Stdlib.result</span> Lwt.t</span></code></dt><dd><p><code>compact t ()</code> scans the disk for unused space and attempts to fill it and shrink the file. This is useful if the underlying block device doesn't support discard and we must emulate it.</p></dd></dl><dl><dt class="spec value" id="val-discard"><a href="#val-discard" class="anchor"></a><code><span class="keyword">val</span> discard : <a href="index.html#type-t">t</a> <span>&#45;&gt;</span> <span>sector:int64</span> <span>&#45;&gt;</span> <span>n:int64</span> <span>&#45;&gt;</span> unit <span>&#45;&gt;</span> <span><span><span>(unit, <a href="index.html#type-write_error">write_error</a>)</span> Stdlib.result</span> Lwt.t</span></code></dt><dd><p><code>discard sector n</code> signals that the <code>n</code> sectors starting at <code>sector</code> are no longer needed and the contents may be discarded. Note the contents may not actually be deleted: this is not a &quot;secure erase&quot;.</p></dd></dl><dl><dt class="spec value" id="val-seek_unmapped"><a href="#val-seek_unmapped" class="anchor"></a><code><span class="keyword">val</span> seek_unmapped : <a href="index.html#type-t">t</a> <span>&#45;&gt;</span> int64 <span>&#45;&gt;</span> <span><span><span>(int64, <a href="index.html#type-error">error</a>)</span> Stdlib.result</span> Lwt.t</span></code></dt><dd><p><code>seek_unmapped t start</code> returns the offset of the next &quot;hole&quot;: a region of the device which is guaranteed to be full of zeroes (typically guaranteed because it is unmapped)</p></dd></dl><dl><dt class="spec value" id="val-seek_mapped"><a href="#val-seek_mapped" class="anchor"></a><code><span class="keyword">val</span> seek_mapped : <a href="index.html#type-t">t</a> <span>&#45;&gt;</span> int64 <span>&#45;&gt;</span> <span><span><span>(int64, <a href="index.html#type-error">error</a>)</span> Stdlib.result</span> Lwt.t</span></code></dt><dd><p><code>seek_mapped t start</code> returns the offset of the next region of the device which may have data in it (typically this is the next mapped region)</p></dd></dl><dl><dt class="spec value" id="val-rebuild_refcount_table"><a href="#val-rebuild_refcount_table" class="anchor"></a><code><span class="keyword">val</span> rebuild_refcount_table : <a href="index.html#type-t">t</a> <span>&#45;&gt;</span> <span><span><span>(unit, <a href="index.html#type-write_error">write_error</a>)</span> Stdlib.result</span> Lwt.t</span></code></dt><dd><p><code>rebuild_refcount_table t</code> rebuilds the refcount table from scratch. Normally we won't update the refcount table live, for performance.</p></dd></dl><dl><dt class="spec type" id="type-check_result"><a href="#type-check_result" class="anchor"></a><code><span class="keyword">type</span> check_result</code><code> = </code><code>{</code><table class="record"><tr id="type-check_result.free" class="anchored"><td class="def field"><a href="#type-check_result.free" class="anchor"></a><code>free : int64;</code></td><td class="doc"><p>unused sectors</p></td></tr><tr id="type-check_result.used" class="anchored"><td class="def field"><a href="#type-check_result.used" class="anchor"></a><code>used : int64;</code></td><td class="doc"><p>used sectors</p></td></tr></table><code>}</code></dt></dl><dl><dt class="spec value" id="val-check"><a href="#val-check" class="anchor"></a><code><span class="keyword">val</span> check : <a href="index.html#argument-1-B">B</a>.t <span>&#45;&gt;</span> <span><span><span>(<a href="index.html#type-check_result">check_result</a>, <span>[ Mirage_block.error <span><span>| `Reference_outside_file</span> of int64 * int64</span> <span><span>| `Duplicate_reference</span> of <span>(int64 * int)</span> * <span>(int64 * int)</span> * int64</span> <span><span>| `Msg</span> of string</span> ]</span>)</span> Stdlib.result</span> Lwt.t</span></code></dt><dd><p><code>check t</code> performs sanity checks of the file, looking for errors. The error <code>`Reference_outside_file (src, dst)</code> means that at offset <code>src</code> there is a reference to offset <code>dst</code> which is outside the file. The error <code>`Duplicate_reference (ref1, ref2, target) means that references
      at both [ref1] and [ref2] both point to the same [target] offset. </code></p></dd></dl><dl><dt class="spec value" id="val-flush"><a href="#val-flush" class="anchor"></a><code><span class="keyword">val</span> flush : <a href="index.html#type-t">t</a> <span>&#45;&gt;</span> <span><span><span>(unit, <a href="index.html#type-write_error">write_error</a>)</span> Stdlib.result</span> Lwt.t</span></code></dt><dd><p><code>flush t</code> flushes any outstanding buffered writes</p></dd></dl><dl><dt class="spec value" id="val-header"><a href="#val-header" class="anchor"></a><code><span class="keyword">val</span> header : <a href="index.html#type-t">t</a> <span>&#45;&gt;</span> <a href="../../Qcow_header/index.html#type-t">Header.t</a></code></dt><dd><p>Return a snapshot of the current header</p></dd></dl><dl><dt class="spec value" id="val-to_config"><a href="#val-to_config" class="anchor"></a><code><span class="keyword">val</span> to_config : <a href="index.html#type-t">t</a> <span>&#45;&gt;</span> <a href="Config/index.html#type-t">Config.t</a></code></dt><dd><p><code>to_config t</code> returns the configuration of a device</p></dd></dl><dl><dt class="spec value" id="val-get_stats"><a href="#val-get_stats" class="anchor"></a><code><span class="keyword">val</span> get_stats : <a href="index.html#type-t">t</a> <span>&#45;&gt;</span> <a href="Stats/index.html#type-t">Stats.t</a></code></dt><dd><p><code>get_stats t</code> returns the runtime statistics of a device</p></dd></dl><div class="spec module" id="module-Debug"><a href="#module-Debug" class="anchor"></a><code><span class="keyword">module</span> <a href="Debug/index.html">Debug</a> : <span class="keyword">sig</span> ... <span class="keyword">end</span></code></div></div></body></html>